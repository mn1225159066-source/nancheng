name: Build Windows Installer

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    tags: [ 'v*' ]

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller pillow pywin32 keyring

      - name: Convert icon.jpg to icon.ico
        shell: bash
        run: |
          python - << 'PY'
          from PIL import Image
          import os
          src = 'icon.jpg'
          if not os.path.exists(src):
              raise SystemExit('icon.jpg not found in repository root')
          img = Image.open(src).convert('RGBA')
          sizes = [(256,256),(128,128),(64,64),(32,32),(16,16)]
          img.save('icon.ico', sizes=sizes)
          print('icon.ico generated')
          PY

      - name: Build with PyInstaller (onedir)
        run: |
          pyinstaller --onedir --noconsole --name "笔尖传奇下载器" --icon icon.ico --add-data "src/ui;src/ui" --add-data "src/core;src/core" --add-data "icon.jpg;." --hidden-import browser_cookie3 --hidden-import websocket --hidden-import fontTools --hidden-import bs4 --hidden-import requests --hidden-import brotli --copy-metadata streamlit --copy-metadata websocket-client --copy-metadata fonttools --copy-metadata beautifulsoup4 --copy-metadata requests --copy-metadata brotli --collect-all streamlit --collect-all browser_cookie3 --collect-all websocket --collect-all fontTools --collect-all bs4 --collect-all keyring run_gui.py

      - name: Install Inno Setup
        run: |
          choco install innosetup -y

      - name: Build Installer with Inno Setup
        run: |
          iscc installer.iss

      - name: Upload installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: bijianchuanqi-installer
          path: dist_installer/*

      - name: Publish Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: dist_installer/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
